from .common import Chord, Key, Alter
from enum import Enum
import logging
# Typing
from typing import Tuple, Union, Dict, List

# Get Logger
logger = logging.getLogger(__name__)

Fret = str

class StringInstrument():
    def __init__(self,  name: str, 
                        tuning: Tuple[Union[Tuple[Key, Alter], Key], ...],
                        frets: Dict[str, List[Fret]] = {}):
        self.name: str = name
        self.tuning: Tuple[Key, ...] = tuning
        self.nb_strings: int = len(self.tuning)
        self.frets: Dict[Chord, List[Fret]] = {}
        self.addChords(frets)

    def getNbStrings(self) -> int:
        return self.nb_strings

    def addChords(self, newfrets: Dict[str, List[Fret]]):
        for chordname, frets in newfrets.items():
            chord = Chord.parse(chordname)
            if chord in self.frets.keys():
                for fret in frets:
                    if fret in self.frets[chord]:
                        logger.warning(f"Trying to add a fret already existing (Instrument = {self.name}, chord = {chordname})")
                    else:
                        self.frets[chord].append(fret)
            else:
                self.frets[chord] = frets

    def getFrets(self, chord: Union[Chord, str]):
        if not isinstance(chord, Chord):
            chord = Chord.parse(chord)
        return self.frets[chord]
    
    def getMaxFretsRange(self, chordnames: List[Union[Chord, str]] = []) -> int:
        if len(chordnames) == 0:
            chordnames = list(self.frets.keys())
        fret_range_max = 0
        for chord in chordnames:
            fret = self.getFrets(chord)[0]
            fret_min = -1
            fret_max = -1
            for f in fret:
                if(f.upper() not in ["X", "0"]):
                    no_fret = int(f)
                    if fret_min == -1:
                        fret_min = no_fret
                    elif fret_min > no_fret:
                        fret_min = no_fret
                    if fret_max == -1:
                        fret_max = no_fret
                    elif fret_max < no_fret:
                        fret_min = no_fret
            fret_range = fret_max - fret_min
            if fret_range > fret_range_max:
                fret_range_max = fret_range
        return fret_range_max + 1


UKULELE_DGBE = StringInstrument("Baritone Ukulele", (Key.D, Key.G, Key.B, Key.E), frets = {
    # C
    "C":      ["2010"], "Cm":     ["1013"], "Caug":    ["2110"],
    "Cdim":   ["1212"], "C7":     ["2313"], "Cm7":     ["1313"],
    "Cmaj7":  ["2413"], "C6":     ["2213"], "Cm6":     ["1213"],
    "Cadd9":  ["0010"], "Cm9":    ["0543"], "C9":      ["2333"],
    "Csus2":  ["0013"], "Csus4":  ["3011"], "C7sus4":  ["5566"],
    # C#
    "C#":     ["3121"], "C#m":    ["2120"], "C#aug":   ["3221"],
    "C#dim":  ["2323"], "C#7":    ["3424"], "C#m7":    ["2424"],
    "C#maj7": ["3524"], "C#6":    ["3324"], "C#m6":    ["2123"],
    "C#add9": ["1121"], "C#m9":   ["1220"], "C#9":     ["1101"],
    "C#sus2": ["1124"], "C#sus4": ["4122"], "C#7sus4": ["6677"],
    # D
    "D":      ["0232"], "Dm":     ["0231"], "Daug":    ["0332"],
    "Ddim":   ["0101"], "D7":     ["0212"], "Dm7":     ["0211"],
    "Dmaj7":  ["0222"], "D6":     ["0202"], "Dm6":     ["0201"],
    "Dadd9":  ["0252"], "Dm9":    ["2231"], "D9":      ["2212"],
    "Dsus2":  ["0230"], "Dsus4":  ["0233"], "D7sus4":  ["0213"],
    # Eb
    "Eb":     ["5343"], "Ebm":    ["4342"], "Ebaug":   ["2003"],
    "Ebdim":  ["1212"], "Eb7":    ["1323"], "Ebm7":    ["1322"],
    "Ebmaj7": ["1333"], "Eb6":    ["1313"], "Ebm6":    ["4546"],
    "Ebadd9": ["3343"], "Ebm9":   ["3342"], "Eb9":     ["2212"],
    "Ebsus2": ["1341"], "Ebsus4": ["1344"], "Eb7sus4": ["1324"],
    # E
    "E":      ["2100"], "Em":     ["2000"], "Eaug":    ["2114"],
    "Edim":   ["2323"], "E7":     ["0100"], "Em7":     ["0000"],
    "Emaj7":  ["1100"], "E6":     ["2424"], "Em6":     ["2020"],
    "Eadd9":  ["2102"], "Em9":    ["2002"], "E9":      ["0102"],
    "Esus2":  ["2452"], "Esus4":  ["2200"], "E7sus4":  ["0200"],
    # F
    "F":      ["3211"], "Fm":     ["3111"], "Faug":    ["3221"],
    "Fdim":   ["0101"], "F7":     ["1211"], "Fm7":     ["1111"],
    "Fmaj7":  ["3210"], "F6":     ["0211"], "Fm6":     ["3131"],
    "Fadd9":  ["3213"], "Fm9":    ["3113"], "F9":      ["1213"],
    "Fsus2":  ["3011"], "Fsus4":  ["3311"], "F7sus4":  ["1311"],
    # F#
    "F#":     ["4322"], "F#m":    ["4222"], "F#aug":   ["0332"],
    "F#dim":  ["1212"], "F#7":    ["2322"], "F#m7":    ["2222"],
    "F#maj7": ["3322"], "F#6":    ["1322"], "F#m6":    ["1222"],
    "F#add9": ["4324"], "F#m9":   ["2102"], "F#9":     ["2324"],
    "F#sus2": ["4122"], "F#sus4": ["4422"], "F#7sus4": ["2422"],
    # G
    "G":      ["0003"], "Gm":     ["0333"], "Gaug":    ["1003"],
    "Gdim":   ["2323"], "G7":     ["0001"], "Gm7":     ["3333"],
    "Gmaj7":  ["0002"], "G6":     ["0000"], "Gm6":     ["0330"],
    "Gadd9":  ["0203"], "Gm9":    ["5335"], "G9":      ["0201"],
    "Gsus2":  ["0233"], "Gsus4":  ["0013"], "G7sus4":  ["0011"],
    # G#
    "G#":     ["1114"], "G#m":    ["1444"], "G#aug":   ["2110"],
    "G#dim":  ["0101"], "G#7":    ["1112"], "G#m7":    ["1102"],
    "G#maj7": ["1113"], "G#6":    ["1111"], "G#m6":    ["1441"],
    "G#add9": ["1314"], "G#m9":   ["1304"], "G#9":     ["1312"],
    "G#sus2": ["1344"], "G#sus4": ["1124"], "G#7sus4": ["1122"],
    # A
    "A":      ["2220"], "Am":     ["2210"], "Aaug":    ["3221"],
    "Adim":   ["1212"], "A7":     ["2223"], "Am7":     ["2213"],
    "Amaj7":  ["2224"], "A6":     ["2222"], "Am6":     ["2212"],
    "Aadd9":  ["2425"], "Am9":    ["2505"], "A9":      ["2423"],
    "Asus2":  ["2200"], "Asus4":  ["0230"], "A7sus4":  ["2233"],
    # Bb
    "Bb":     ["0331"], "Bbm":    ["3321"], "Bbaug":   ["0332"],
    "Bbdim":  ["2323"], "Bb7":    ["3334"], "Bbm7":    ["3324"],
    "Bbmaj7": ["3335"], "Bb6":    ["3333"], "Bbm6":    ["3021"],
    "Bbadd9": ["0311"], "Bbm9":   ["3506"], "Bb9":     ["0111"],
    "Bbsus2": ["3311"], "Bbsus4": ["1341"], "Bb7sus4": ["3344"],
    # B
    "B":      ["1402"], "Bm":     ["0432"], "Baug":    ["1003"],
    "Bdim":   ["0401"], "B7":     ["1202"], "Bm7":     ["0202"],
    "Bmaj7":  ["1302"], "B6":     ["4444"], "Bm6":     ["0102"],
    "Badd9":  ["1422"], "Bm9":    ["0605"], "B9":      ["1222"],
    "Bsus2":  ["4422"], "Bsus4":  ["2452"], "B7sus4":  ["4455"],
})


UKULELE_GCEA = StringInstrument("Ukulele", (Key.G, Key.C, Key.E, Key.A), frets = {
    # C
    "C":      ["0003"], "Cm":     ["0333"], "Caug":    ["1003"],
    "Cdim":   ["x323"], "C7":     ["0001"], "Cm7":     ["3333"],
    "Cmaj7":  ["0002"], "C6":     ["0000"], "Cm6":     ["2333"],
    "Cadd9":  ["0433"], "Cm9":    ["5335"], "C9":      ["0201"],
    "Csus2":  ["0233"], "Csus4":  ["0013"], "C7sus4":  ["0011"],
    # C#
    "C#":     ["1114"], "C#m":    ["1444"], "C#aug":   ["2110"],
    "C#dim":  ["0104"], "C#7":    ["1112"], "C#m7":    ["1102"],
    "C#maj7": ["1113"], "C#6":    ["1111"], "C#m6":    ["1101"],
    "C#add9": ["1314"], "C#m9":   ["1304"], "C#9":     ["1312"],
    "C#sus2": ["1344"], "C#sus4": ["1124"], "C#7sus4": ["1122"],
    # D
    "D":      ["2220"], "Dm":     ["2210"], "Daug":    ["3221"],
    "Ddim":   ["121x"], "D7":     ["2223"], "Dm7":     ["2213"],
    "Dmaj7":  ["2224"], "D6":     ["2222"], "Dm6":     ["2212"],
    "Dadd9":  ["2425"], "Dm9":    ["2505"], "D9":      ["2423"],
    "Dsus2":  ["2200"], "Dsus4":  ["0230"], "D7sus4":  ["2233"],
    # Eb
    "Eb":     ["0331"], "Ebm":    ["3321"], "Ebaug":   ["0332"],
    "Ebdim":  ["2320"], "Eb7":    ["3334"], "Ebm7":    ["3324"],
    "Ebmaj7": ["3335"], "Eb6":    ["3333"], "Ebm6":    ["3323"],
    "Ebadd9": ["0311"], "Ebm9":   ["35x6"], "Eb9":     ["0111"],
    "Ebsus2": ["3344"], "Ebsus4": ["1341"], "Eb7sus4": ["3344"],
    # E
    "E":      ["1402"], "Em":     ["0432"], "Eaug":    ["1003"],
    "Edim":   ["0101"], "E7":     ["1202"], "Em7":     ["0202"],
    "Emaj7":  ["1302"], "E6":     ["4444"], "Em6":     ["0102"],
    "Eadd9":  ["1422"], "Em9":    ["0422"], "E9":      ["1222"],
    "Esus2":  ["4422"], "Esus4":  ["2452"], "E7sus4":  ["4455"],
    # F
    "F":      ["2010"], "Fm":     ["1013"], "Faug":    ["2110"],
    "Fdim":   ["1212"], "F7":     ["2313"], "Fm7":     ["1313"],
    "Fmaj7":  ["2413"], "F6":     ["2213"], "Fm6":     ["1213"],
    "Fadd9":  ["0010"], "Fm9":    ["0543"], "F9":      ["2333"],
    "Fsus2":  ["0013"], "Fsus4":  ["3011"], "F7sus4":  ["5566"],
    # F#
    "F#":     ["3121"], "F#m":    ["2120"], "F#aug":   ["3221"],
    "F#dim":  ["2323"], "F#7":    ["3424"], "F#m7":    ["2424"],
    "F#maj7": ["3524"], "F#6":    ["3324"], "F#m6":    ["2123"],
    "F#add9": ["1121"], "F#m9":   ["1220"], "F#9":     ["1101"],
    "F#sus2": ["1124"], "F#sus4": ["4122"], "F#7sus4": ["6677"],
    # G
    "G":      ["0232"], "Gm":     ["0231"], "Gaug":    ["0332"],
    "Gdim":   ["0131"], "G7":     ["0212"], "Gm7":     ["0211"],
    "Gmaj7":  ["0222"], "G6":     ["0202"], "Gm6":     ["0201"],
    "Gadd9":  ["0252"], "Gm9":    ["2231"], "G9":      ["2212"],
    "Gsus2":  ["0230"], "Gsus4":  ["0233"], "G7sus4":  ["0213"],
    # G#
    "G#":     ["5343"], "G#m":    ["4342"], "G#aug":   ["1003"],
    "G#dim":  ["1212"], "G#7":    ["1323"], "G#m7":    ["1322"],
    "G#maj7": ["1333"], "G#6":    ["1313"], "G#m6":    ["4546"],
    "G#add9": ["3343"], "G#m9":   ["3342"], "G#9":     ["2212"],
    "G#sus2": ["1341"], "G#sus4": ["1344"], "G#7sus4": ["1324"],
    # A
    "A":      ["2100"], "Am":     ["2000"], "Aaug":    ["2114"],
    "Adim":   ["2323"], "A7":     ["0100"], "Am7":     ["0000"],
    "Amaj7":  ["1100"], "A6":     ["2120"], "Am6":     ["2020"],
    "Aadd9":  ["2102"], "Am9":    ["2002"], "A9":      ["0102"],
    "Asus2":  ["2452"], "Asus4":  ["2200"], "A7sus4":  ["0200"],
    # Bb
    "Bb":     ["3211"], "Bbm":    ["3111"], "Bbaug":   ["3221"],
    "Bbdim":  ["0101"], "Bb7":    ["1211"], "Bbm7":    ["1111"],
    "Bbmaj7": ["3210"], "Bb6":    ["0211"], "Bbm6":    ["3131"],
    "Bbadd9": ["3213"], "Bbm9":   ["3113"], "Bb9":     ["3243"],
    "Bbsus2": ["3011"], "Bbsus4": ["3311"], "Bb7sus4": ["1311"],
    # B
    "B":      ["4322"], "Bm":     ["4222"], "Baug":    ["4332"],
    "Bdim":   ["4212"], "B7":     ["2322"], "Bm7":     ["2222"],
    "Bmaj7":  ["4321"], "B6":     ["1322"], "Bm6":     ["1222"],
    "Badd9":  ["4324"], "Bm9":    ["2102"], "B9":      ["4354"],
    "Bsus2":  ["4122"], "Bsus4":  ["4422"], "B7sus4":  ["2422"],
})


GUITAR_EADGBE = StringInstrument("Guitar", (Key.E, Key.A, Key.D, Key.G, Key.B, Key.E), frets = {
    # C
    "C":       ["x32010"], "Cm":      ["x31013"], "Caug":    ["x3211x"], 
    "Cdim":    ["x31x12"], "C7":      ["x32310"], "Cm7":     ["8x888x"], 
    "Cmaj7":   ["332000"], "C6":      ["x32210"], "Cm6":     ["x31213"], 
    "Cadd9":   ["x32030"], "Cm9":     ["x31333"], "C9":      ["032030"], 
    "Csus2":   ["x30013"], "Csus4":   ["x33011"], "C7sus4":  ["x33311"], 
    # C#
    "C#":      ["x43121"], "C#m":     ["x4212x"], "C#aug":   ["x44422"], 
    "C#dim":   ["x42x23"], "C#7":     ["x4342x"], "C#m7":    ["9x999x"], 
    "C#maj7":  ["x43111"], "C#6":     ["x4332x"], "C#m6":    ["x42324"], 
    "C#add9":  ["x43141"], "C#m9":    ["x42444"], "C#9":     ["443444"], 
    "C#sus2":  ["446644"], "C#sus4":  ["x4412x"], "C#7sus4": ["x44422"], 
    # D
    "D":       ["xx0232"], "Dm":      ["xx0231"], "Daug":    ["xx0332"], 
    "Ddim":    ["xx01x1"], "D7":      ["xx0212"], "Dm7":     ["xx0211"], 
    "Dmaj7":   ["xx0222"], "D6":      ["xx0202"], "Dm6":     ["xx0201"], 
    "Dadd9":   ["x54252"], "Dm9":     ["100210"], "D9":      ["554555"], 
    "Dsus2":   ["xx0230"], "Dsus4":   ["xx0233"], "D7sus4":  ["xx0213"], 
    # Eb
    "Eb":      ["xx1343"], "Ebm":     ["xx1342"], "Ebaug":   ["xx5443"], 
    "Ebdim":   ["xx12x2"], "Eb7":     ["xx1323"], "Ebm7":    ["xx1322"], 
    "Ebmaj7":  ["x11333"], "Eb6":     ["xx1313"], "Ebm6":    ["x11312"], 
    "Ebadd9":  ["x65363"], "Ebm9":    ["x64666"], "Eb9":     ["xx1021"], 
    "Ebsus2":  ["111341"], "Ebsus4":  ["xx1344"], "Eb7sus4": ["xx1324"], 
    # E
    "E":       ["022100"], "Em":      ["022000"], "Eaug":    ["032110"], 
    "Edim":    ["xx23x3"], "E7":      ["020100"], "Em7":     ["0x000x"], 
    "Emaj7":   ["021100"], "E6":      ["022120"], "Em6":     ["022020"], 
    "Eadd9":   ["022102"], "Em9":     ["020002"], "E9":      ["020102"], 
    "Esus2":   ["222452"], "Esus4":   ["022200"], "E7sus4":  ["020200"], 
    # F
    "F":       ["133211"], "Fm":      ["133111"], "Faug":    ["xx3221"], 
    "Fdim":    ["xx34x4"], "F7":      ["131211"], "Fm7":     ["1x111x"], 
    "Fmaj7":   ["xx3210"], "F6":      ["1x3231"], "Fm6":     ["1x0111"], 
    "Fadd9":   ["xx3213"], "Fm9":     ["131113"], "F9":      ["131213"], 
    "Fsus2":   ["133x13"], "Fsus4":   ["133311"], "F7sus4":  ["131311"], 
    # F#
    "F#":      ["244322"], "F#m":     ["244222"], "F#aug":   ["xx4332"], 
    "F#dim":   ["20x21x"], "F#7":     ["242322"], "F#m7":    ["2x222x"], 
    "F#maj7":  ["243322"], "F#6":     ["2x132x"], "F#m6":    ["2x1222"], 
    "F#add9":  ["21x122"], "F#m9":    ["202120"], "F#9":     ["242324"], 
    "F#sus2":  ["2xx122"], "F#sus4":  ["244422"], "F#7sus4": ["242422"], 
    # G
    "G":       ["320003"], "Gm":      ["310033"], "Gaug":    ["32100x"], 
    "Gdim":    ["31x32x"], "G7":      ["320001"], "Gm7":     ["3x333x"], 
    "Gmaj7":   ["320002"], "G6":      ["320000"], "Gm6":     ["3x2333"], 
    "Gadd9":   ["300203"], "Gm9":     ["300331"], "G9":      ["300001"], 
    "Gsus2":   ["300033"], "Gsus4":   ["330013"], "G7sus4":  ["330011"], 
    # G#
    "G#":      ["43111x"], "G#m":     ["466444"], "G#aug":   ["43211x"], 
    "G#dim":   ["42x43x"], "G#7":     ["xx1112"], "G#m7":    ["4x444x"], 
    "G#maj7":  ["465544"], "G#6":     ["x31111"], "G#m6":    ["4x344x"], 
    "G#add9":  ["43x34x"], "G#m9":    ["411102"], "G#9":     ["43434x"], 
    "G#sus2":  ["4xx344"], "G#sus4":  ["xx1124"], "G#7sus4": ["xx1122"], 
    # A
    "A":       ["x02220"], "Am":      ["x02210"], "Aaug":    ["x03221"], 
    "Adim":    ["x0121x"], "A7":      ["x02020"], "Am7":     ["x02010"], 
    "Amaj7":   ["x02120"], "A6":      ["x02222"], "Am6":     ["x02212"], 
    "Aadd9":   ["x02420"], "Am9":     ["x02413"], "A9":      ["542000"], 
    "Asus2":   ["x02200"], "Asus4":   ["x02230"], "A7sus4":  ["x02030"], 
    # Bb
    "Bb":      ["x13331"], "Bbm":     ["x13321"], "Bbaug":   ["x1433x"], 
    "Bbdim":   ["x1232x"], "Bb7":     ["x13131"], "Bbm7":    ["5x555x"], 
    "Bbmaj7":  ["x13231"], "Bb6":     ["x13333"], "Bbm6":    ["x13x23"], 
    "Bbadd9":  ["x10311"], "Bbm9":    ["xx3524"], "Bb9":     ["x10111"], 
    "Bbsus2":  ["113311"], "Bbsus4":  ["x13341"], "Bb7sus4": ["x13141"], 
    # B
    "B":       ["224442"], "Bm":      ["224432"], "Baug":    ["x2100x"], 
    "Bdim":    ["x20x01"], "B7":      ["x21202"], "Bm7":     ["7x777x"], 
    "Bmaj7":   ["224342"], "B6":      ["x2110x"], "Bm6":     ["220102"], 
    "Badd9":   ["x21x22"], "Bm9":     ["x20222"], "B9":      ["x21222"], 
    "Bsus2":   ["224422"], "Bsus4":   ["224452"], "B7sus4":  ["x22200"],
})


class STRING_INSTRUMENTS(Enum):
    UKULELE_DGBE = UKULELE_DGBE
    UKULELE_GCEA = UKULELE_GCEA
    GUITAR_EADGBE = GUITAR_EADGBE


